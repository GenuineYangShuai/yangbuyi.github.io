---
slug: qqLogin
title: ä»é›¶ç©è½¬ç¬¬ä¸‰æ–¹QQç™»é™†
author: æ¨ä¸æ˜“å‘€
author_title: Javaå¼€å‘å·¥ç¨‹å¸ˆ
author_url: https://github.com/GenuineYangshuai
description: ä»é›¶ç©è½¬ç¬¬ä¸‰æ–¹QQç™»é™†
author_image_url: https://img2020.cnblogs.com/blog/1735255/202008/1735255-20200821211621285-960805374.png
tags: [åç«¯,Oauth2.0]
---

# ä»é›¶ç©è½¬ç¬¬ä¸‰æ–¹ç™»å½•ä¹‹QQç™»å½•

### å‰è¨€

åœ¨çœŸæ­£å¼€å§‹å¯¹æ¥ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠä¸€èŠåå°çš„æ–¹æ¡ˆè®¾è®¡ã€‚æ—¢ç„¶æ˜¯å¯¹æ¥ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œé‚£å°±å…ä¸äº†å¦‚ä½•å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚é¦–å…ˆéœ€è¦æ˜ç¡®ä¸€ç‚¹çš„æ˜¯ï¼Œç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹ç™»å½•æˆåŠŸä¹‹åï¼Œ
æˆ‘ä»¬èƒ½æ‹¿åˆ°çš„ä»…ä»…æ˜¯ä¸€ä¸ªä»£è¡¨ç”¨æˆ·å”¯ä¸€èº«ä»½çš„IDï¼ˆå¾®åšæ˜¯çœŸå®uidï¼ŒQQæ˜¯åŠ å¯†çš„openIDï¼‰ä»¥åŠç”¨æ¥è¯†åˆ«èº«ä»½çš„accessTokenï¼Œå½“ç„¶è¿˜æœ‰æ˜µç§°ã€å¤´åƒã€æ€§åˆ«ç­‰æœ‰é™èµ„æ–™ï¼Œ
å¯¹æ¥ç¬¬ä¸‰æ–¹ç™»å½•çš„å…³é”®å°±æ˜¯å¦‚ä½•ç¡®å®šç”¨æˆ·æ˜¯åˆæ³•ç™»å½•ï¼Œå¦‚æœç¡®å®šè¿™æ¬¡ç™»å½•çš„å’Œä¸Šæ¬¡ç™»å½•çš„æ˜¯åŒä¸€ä¸ªäººå¹¶ä¸”ä¸æ˜¯å‡å†’çš„ã€‚å…¶å®è¿™ä¸ªå¹¶ä¸ç”¨æˆ‘ä»¬ç‰¹åˆ«æ“å¿ƒï¼Œå°±ä»¥å¾®åšç™»å½•ä¸ºä¾‹ï¼Œ
ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åä¼šå›è°ƒä¸€ä¸ªcodeç»™æˆ‘ä»¬ï¼Œç„¶åæˆ‘ä»¬å†æ‹¿codeå»å¾®åšé‚£æ¢å– accessToken ï¼Œå¦‚æœè¿™ä¸ªcodeæ˜¯ç”¨æˆ·ä¹±å¡«çš„ï¼Œé‚£è¿™ä¸€å…³è‚¯å®šè¿‡ä¸äº†ï¼Œæ‰€ä»¥ï¼Œå‰é¢çš„æ‹…å¿ƒæœ‰ç‚¹å¤šä½™ï¼Œå“ˆå“ˆã€‚

# 1. è®¤è¯†Oauth2.0

ç°åœ¨å¾ˆå¤šç½‘ç«™éƒ½è¦ä¸ç®¡æ˜¯ä¸ºäº†å¼•æµä¹Ÿå¥½ï¼Œä¸ºäº†ç”¨æˆ·æ–¹ä¾¿ä¹Ÿå¥½ä¸€èˆ¬éƒ½æœ‰ç¬¬ä¸‰æ–¹è´¦å·ç™»é™†çš„éœ€æ±‚ï¼Œä»Šå¤©ä»¥QQç™»é™†ä¸ºä¾‹ï¼Œæ¥å®ç°ä¸€ä¸ªæœ€ç®€å•çš„ç¬¬ä¸‰æ–¹ç™»é™†ã€‚
ç›®å‰ä¸»æµçš„ç¬¬ä¸‰æ–¹ç™»å½•éƒ½æ˜¯ä¾èµ–çš„Oauth2.0å®ç°çš„ï¼Œæœ€å¸¸è§çš„å°±æ˜¯åœ¨å„ç§ä¸­å°å‹ç½‘ç«™æˆ–è€…Appä¸­çš„QQç™»å½•ï¼Œå¾®ä¿¡ç™»å½•ç­‰ç­‰ã€‚æ‰€ä»¥æˆ‘å»ºè®®æƒ³è¦å­¦ä¹ å’Œå®ç°ç¬¬ä¸‰æ–¹ç™»å½•åŒå­¦å»äº†è§£ä¸‹è¿™ä¸ªåè®®ã€‚
<!-- truncate -->
### å¿…é¡»è¦åŸŸåå¹¶ä¸”è¿›è¡Œå¤‡æ¡ˆ

æ¯”å¦‚æˆ‘çš„åŸŸåï¼š https://yangbuyi.top/
å› ä¸ºè…¾è®¯æœ‰ä¸€ä¸ªåŸŸåè®¤è¯æœºåˆ¶å•¥çš„ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚


2.å®åè®¤è¯
QQç™»å½•æˆ‘ä»¬å¯¹æ¥çš„æ˜¯QQäº’è”ï¼Œåœ°å€ï¼š`https://connect.qq.com` ,é¦–å…ˆéœ€è¦æ³¨å†Œæˆä¸ºå¼€å‘è€…å¹¶å®åè®¤è¯ï¼Œéœ€è¦æ‰‹æŒèº«ä»½è¯ç…§ç‰‡ï¼Œå…·ä½“å°±ä¸è®²äº†ã€‚


### 2.1ã€è¿›è¡Œç”³è¯·å¼€å‘è€…èº«ä»½

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1TqqAILjMAAH9Gwl1OkA745.png)


### 2.2 åˆ›å»ºåº”ç”¨

#### è¿›å…¥åº”ç”¨ç®¡ç†é¡µé¢åˆ›å»ºåº”ç”¨ï¼Œæ ¹æ®å®é™…éœ€è¦æ˜¯åˆ›å»ºç½‘ç«™åº”ç”¨è¿˜æ˜¯ç§»åŠ¨åº”ç”¨ï¼Œæˆ‘è¿™é‡Œæ˜¯ç½‘ç«™åº”ç”¨ï¼š

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1TtSANtMvAAAdHxw4KeI681.png)
![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1T0CAagI9AAB2u5u6IJw161.png)
![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1T1SAWCMZAACWLxHFyO8873.png)

#### æäº¤æˆåŠŸå®Œæ­¥åç­‰å¾…å®¢æœå®¡æ ¸å³å¯

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1T3WAbRYeAABbgxej_d0886.png)

#### è¿™æ˜¯æˆ‘ç½‘ç«™çš„åŸºæœ¬æ¥å£ä¿¡æ¯

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1TzCAWQHoAACu-DtnB0M224.png)

# QQç™»é™†æµç¨‹

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1T8KAJaADAAHR-IhP1RQ892.png)

#### è¯·æ±‚å‚æ•°

![image-20210413172128896](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1YxyAM74iAAHtcyFsA9Q912.png)

# åˆ›å»ºspringbootå·¥ç¨‹ 

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1UK2AZG4VAAB-DSvfHG4172.png)

#### ä¾èµ–

```java
        <!-- qqç™»é™†é›†æˆ å¼€å§‹ -->
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpcore</artifactId>
            <version>4.4.11</version>
        </dependency>
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5.8</version>
        </dependency>

        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpasyncclient</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpmime</artifactId>
        </dependency>
        <!--jsonè½¬æ¢å·¥å…·-->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.8.5</version>
        </dependency>
        <!--QQSDK-->
        <dependency>
            <groupId>net.gplatform</groupId>
            <artifactId>Sdk4J</artifactId>
            <version>2.0</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.62</version>
        </dependency>
        <!-- qqç™»é™†é›†æˆ ç»“æŸ -->


        <!-- æ¨¡æ¿ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>


        <!-- å…¶å®ƒé…ç½® -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>


        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
```



### åˆ›å»ºhttpè¯·æ±‚å·¥å…·

```java
import com.alibaba.fastjson.JSONObject;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.NameValuePair;
import org.apache.http.client.HttpClient;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.TrustStrategy;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.impl.conn.PoolingHttpClientConnectionManager;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.ssl.SSLContextBuilder;
import org.apache.http.util.EntityUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.net.ssl.HostnameVerifier;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSession;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.security.GeneralSecurityException;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;


/**
 * description:  æ¨ä¸æ˜“ç½‘ç«™ :www.yangbuyi.top
 * ClassName:  HttpsUtils
 * create:  2020-06-24 17:30
 *
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 **/

public class HttpsUtils {
      private static PoolingHttpClientConnectionManager connMgr;
      private static RequestConfig requestConfig;
      private static final int MAX_TIMEOUT = 7000;
      
      private static final Logger logger = LoggerFactory.getLogger(HttpsUtils.class);
      
      static {
            // è®¾ç½®è¿æ¥æ± 
            connMgr = new PoolingHttpClientConnectionManager();
            // è®¾ç½®è¿æ¥æ± å¤§å°
            connMgr.setMaxTotal(100);
            connMgr.setDefaultMaxPerRoute(connMgr.getMaxTotal());
            // Validate connections after 1 sec of inactivity
            connMgr.setValidateAfterInactivity(1000);
            RequestConfig.Builder configBuilder = RequestConfig.custom();
            // è®¾ç½®è¿æ¥è¶…æ—¶
            configBuilder.setConnectTimeout(MAX_TIMEOUT);
            // è®¾ç½®è¯»å–è¶…æ—¶
            configBuilder.setSocketTimeout(MAX_TIMEOUT);
            // è®¾ç½®ä»è¿æ¥æ± è·å–è¿æ¥å®ä¾‹çš„è¶…æ—¶
            configBuilder.setConnectionRequestTimeout(MAX_TIMEOUT);
            
            requestConfig = configBuilder.build();
      }
      
      /**
       * å‘é€ GET è¯·æ±‚ï¼ˆHTTPï¼‰ï¼Œä¸å¸¦è¾“å…¥æ•°æ®
       *
       * @param url
       * @return
       */
      public static String doGet(String url) {
            return doGet(url, new HashMap<String, Object>());
      }
      
      /**
       * å‘é€ GET è¯·æ±‚ï¼ˆHTTPï¼‰ï¼ŒK-Vå½¢å¼
       *
       * @param url
       * @param params
       * @return
       */
      public static String doGet(String url, Map<String, Object> params) {
            String apiUrl = url;
            StringBuffer param = new StringBuffer();
            int i = 0;
            for (String key : params.keySet()) {
                  if (i == 0)
                        param.append("?");
                  else
                        param.append("&");
                  param.append(key).append("=").append(params.get(key));
                  i++;
            }
            apiUrl += param;
            String result = null;
            HttpClient httpClient = null;
            if (apiUrl.startsWith("https")) {
                  httpClient = HttpClients.custom().setSSLSocketFactory(createSSLConnSocketFactory())
                        .setConnectionManager(connMgr).setDefaultRequestConfig(requestConfig).build();
            } else {
                  httpClient = HttpClients.createDefault();
            }
            try {
                  HttpGet httpGet = new HttpGet(apiUrl);
                  HttpResponse response = httpClient.execute(httpGet);
                  HttpEntity entity = response.getEntity();
                  if (entity != null) {
                        InputStream instream = entity.getContent();
                        result = new BufferedReader(new InputStreamReader(instream)).lines().collect(Collectors.joining(System.lineSeparator()));
                  }
            } catch (IOException e) {
                  logger.error(e.getMessage());
            }
            return result;
      }
      
      /**
       * å‘é€ POST è¯·æ±‚ï¼ˆHTTPï¼‰ï¼Œä¸å¸¦è¾“å…¥æ•°æ®
       *
       * @param apiUrl
       * @return
       */
      public static String doPost(String apiUrl) {
            return doPost(apiUrl, new HashMap<String, Object>());
      }
      
      /**
       * å‘é€ POST è¯·æ±‚ï¼ŒK-Vå½¢å¼
       *
       * @param apiUrl APIæ¥å£URL
       * @param params å‚æ•°map
       * @return
       */
      public static String doPost(String apiUrl, Map<String, Object> params) {
            CloseableHttpClient httpClient = null;
            if (apiUrl.startsWith("https")) {
                  httpClient = HttpClients.custom().setSSLSocketFactory(createSSLConnSocketFactory())
                        .setConnectionManager(connMgr).setDefaultRequestConfig(requestConfig).build();
            } else {
                  httpClient = HttpClients.createDefault();
            }
            String httpStr = null;
            HttpPost httpPost = new HttpPost(apiUrl);
            CloseableHttpResponse response = null;
            
            try {
                  httpPost.setConfig(requestConfig);
                  List<NameValuePair> pairList = new ArrayList<>(params.size());
                  for (Map.Entry<String, Object> entry : params.entrySet()) {
                        NameValuePair pair = new BasicNameValuePair(entry.getKey(), entry.getValue().toString());
                        pairList.add(pair);
                  }
                  httpPost.setEntity(new UrlEncodedFormEntity(pairList, Charset.forName("UTF-8")));
                  response = httpClient.execute(httpPost);
                  HttpEntity entity = response.getEntity();
                  httpStr = EntityUtils.toString(entity, "UTF-8");
            } catch (IOException e) {
                  logger.error(e.getMessage());
            } finally {
                  if (response != null) {
                        try {
                              EntityUtils.consume(response.getEntity());
                        } catch (IOException e) {
                              logger.error(e.getMessage());
                        }
                  }
            }
            return httpStr;
      }
      
      /**
       * å‘é€ POST è¯·æ±‚ï¼ŒJSONå½¢å¼
       *
       * @param apiUrl
       * @param json   jsonå¯¹è±¡
       * @return
       */
      public static String doPost(String apiUrl, Object json) {
            CloseableHttpClient httpClient = null;
            if (apiUrl.startsWith("https")) {
                  httpClient = HttpClients.custom().setSSLSocketFactory(createSSLConnSocketFactory())
                        .setConnectionManager(connMgr).setDefaultRequestConfig(requestConfig).build();
            } else {
                  httpClient = HttpClients.createDefault();
            }
            String httpStr = null;
            HttpPost httpPost = new HttpPost(apiUrl);
            CloseableHttpResponse response = null;
            
            try {
                  httpPost.setConfig(requestConfig);
                  StringEntity stringEntity = new StringEntity(json.toString(), "UTF-8");// è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
                  stringEntity.setContentEncoding("UTF-8");
                  stringEntity.setContentType("application/json");
                  httpPost.setEntity(stringEntity);
                  response = httpClient.execute(httpPost);
                  HttpEntity entity = response.getEntity();
                  httpStr = EntityUtils.toString(entity, "UTF-8");
            } catch (IOException e) {
                  logger.error(e.getMessage());
            } finally {
                  if (response != null) {
                        try {
                              EntityUtils.consume(response.getEntity());
                        } catch (IOException e) {
                              logger.error(e.getMessage());
                        }
                  }
            }
            return httpStr;
      }
      
      /**
       * åˆ›å»ºSSLå®‰å…¨è¿æ¥
       *
       * @return
       */
      private static SSLConnectionSocketFactory createSSLConnSocketFactory() {
            SSLConnectionSocketFactory sslsf = null;
            try {
                  SSLContext sslContext = new SSLContextBuilder().loadTrustMaterial(null, new TrustStrategy() {
                        
                        @Override
                        public boolean isTrusted(X509Certificate[] chain, String authType) throws CertificateException {
                              return true;
                        }
                  }).build();
                  sslsf = new SSLConnectionSocketFactory(sslContext, new HostnameVerifier() {
                        
                        @Override
                        public boolean verify(String arg0, SSLSession arg1) {
                              return true;
                        }
                  });
            } catch (GeneralSecurityException e) {
                  logger.error(e.getMessage());
            }
            return sslsf;
      }
      
      /*gitHubå¼€å§‹*/
      /**
       * å‘é€getè¯·æ±‚ï¼Œåˆ©ç”¨javaä»£ç å‘é€è¯·æ±‚
       * @param url
       * @return
       * @throws Exception
       */
      public static String doGetHub(String url) throws Exception{
            
            CloseableHttpClient httpclient = HttpClients.createDefault();
            
            HttpGet httpGet = new HttpGet(url);
            // å‘é€äº†ä¸€ä¸ªhttpè¯·æ±‚
            CloseableHttpResponse response = httpclient.execute(httpGet);
            // å¦‚æœå“åº”200æˆåŠŸ,è§£æå“åº”ç»“æœ
            if(response.getStatusLine().getStatusCode()==200){
                  // è·å–å“åº”çš„å†…å®¹
                  HttpEntity responseEntity = response.getEntity();
                  
                  return EntityUtils.toString(responseEntity);
            }
            return null;
      }
      /**
       * å°†å­—ç¬¦ä¸²è½¬æ¢æˆmap
       * @param responseEntity
       * @return
       */
      public static Map<String,String> getMap(String responseEntity) {
            
            Map<String, String> map = new HashMap<>();
            // ä»¥&æ¥è§£æå­—ç¬¦ä¸²
            String[] result = responseEntity.split("\\&");
            
            for (String str : result) {
                  // ä»¥=æ¥è§£æå­—ç¬¦ä¸²
                  String[] split = str.split("=");
                  // å°†å­—ç¬¦ä¸²å­˜å…¥mapä¸­
                  if (split.length == 1) {
                        map.put(split[0], null);
                  } else {
                        map.put(split[0], split[1]);
                  }
                  
            }
            return map;
      }
      
      /**
       * é€šè¿‡jsonè·å¾—map
       * @param responseEntity
       * @return
       */
      public static Map<String,String> getMapByJson(String responseEntity) {
            Map<String, String> map = new HashMap<>();
            // é˜¿é‡Œå·´å·´fastjson  å°†jsonè½¬æ¢æˆmap
            JSONObject jsonObject = JSONObject.parseObject(responseEntity);
            for (Map.Entry<String, Object> entry : jsonObject.entrySet()) {
                  String key = entry.getKey();
                  // å°†objè½¬æ¢æˆstring
                  String value = String.valueOf(entry.getValue()) ;
                  map.put(key, value);
            }
            return map;
      }
      /*gitHubç»“æŸ*/
      
      
}

```

### åˆ›å»ºè·¨åŸŸé…ç½®ç±» ä»¥é˜²ä¸‡ä¸€å‡ºç°è·¨åŸŸé—®é¢˜

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

/**
 * ClassName: CorsAutoConfig
 *
 * @author yangshuai
 * @Date: 2021-04-13 14:54
 * @Description: $
 **/
@Configuration
public class CorsAutoConfig {
    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource urlBasedCorsConfigurationSource = new UrlBasedCorsConfigurationSource();
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.addAllowedHeader("*");
        corsConfiguration.addAllowedMethod("*");
        // è¡¨ç¤ºä»€ä¹ˆåŸŸåè·¨åŸŸ *è¡¨ç¤ºå…¨éƒ¨éƒ½è·¨åŸŸ
        corsConfiguration.addAllowedOrigin("*");
        // æ³¨å…¥è¿›å»
        urlBasedCorsConfigurationSource.registerCorsConfiguration("/**", corsConfiguration);

        CorsFilter corsFilter = new CorsFilter(urlBasedCorsConfigurationSource);
        return corsFilter;
    }
}
```

### åˆ›å»ºLogincontroller

```java
import com.google.gson.Gson;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import top.yangbuyi.QQ.OAuthProperties;
import top.yangbuyi.QQ.vo.QQDTO;
import top.yangbuyi.QQ.vo.QQOpenidDTO;
import top.yangbuyi.common.HttpsUtils;

import javax.management.RuntimeErrorException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.websocket.server.PathParam;
import java.io.IOException;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * @description: æ¨ä¸æ˜“ç½‘ç«™:www.yangbuyi.top
 * @program: qqlogindemo
 * @ClassName: loginController
 * @create: 2020-08-18 14:41
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 * @loginController: ç¬¬ä¸‰æ–¹QQç™»é™†
 **/

@Controller
@Slf4j
@RequestMapping("api")
public class loginController {

	  /**
	   * è®¤è¯å‚æ•°
	   */
	  @Autowired
	  private OAuthProperties oauth;


	  /**
	   * è°ƒç”¨QQç™»é™†æ¥å£
	   * æµç¨‹ï¼š å…ˆè°ƒç”¨æ¥å£è·å–codeï¼Œåœ¨æ ¹æ®codeè·å–access_token,åœ¨æ ¹æ®tokenè·å–å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
	   * @param response
	   */
	  @GetMapping("/login/oauth")
	  public void loginQQ(  HttpServletResponse response) {
			// é‡å®šå‘è®¿é—®QQç™»å½•æœåŠ¡å™¨
			try {
				  response.sendRedirect(oauth.getQQ().getCode_callback_uri() + //è·å–codeç åœ°å€
						  "?client_id=" + oauth.getQQ().getClient_id() //appid
						  +"&state=" + UUID.randomUUID() + //è¿™ä¸ªè¯´æ˜¯é˜²æ”»å‡»çš„ï¼Œå°±ç»™ä¸ªéšæœºuuidå§
						  "&redirect_uri=" + oauth.getQQ().getRedirect_uri() +//è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¿™ä¸ªæ˜¯å›è°ƒåœ°å€ï¼Œå³å°±æ”¶è…¾è®¯è¿”å›çš„codeç 
						  "&response_type=code");
			} catch (IOException e) {
				  e.printStackTrace();
			}
	  }


	  /**
	   * åœ¨qqå¹³å°è®¾ç½®çš„å›è°ƒåœ°å€
	   *
	   * æ¥æ”¶å›è°ƒåœ°å€å¸¦è¿‡æ¥çš„codeç 
	   *
	   * @param code
	   * @param request
	   * @return
	   */
	  @GetMapping("/oauth2")
	  public String authorizeQQ(String code, HttpServletRequest request) {
			HashMap<String, Object> params = new HashMap<>();
			params.put("code", code);
			params.put("grant_type", "authorization_code");
			params.put("redirect_uri", oauth.getQQ().getRedirect_uri());
			params.put("client_id", oauth.getQQ().getClient_id());
			params.put("client_secret", oauth.getQQ().getClient_secret());

			// è·å–è…¾è®¯access token
			Map<String, String> reulsts = getAccess_token(params);
			System.out.println("éå†æ‹¿åˆ°çš„æ•°æ®:");
			for (Map.Entry<String, String> entry : reulsts.entrySet()) {
				  System.out.println(entry.getKey() + "=" + entry.getValue());
			}
			System.out.println("éå†å®Œæ¯•");

			//åˆ°è¿™é‡Œaccess_tokenå·²ç»å¤„ç†å¥½äº†
			//ä¸‹ä¸€æ­¥è·å–openidï¼Œåªæœ‰æ‹¿åˆ°openidæ‰èƒ½æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯
			String openidContent = HttpsUtils.doGet(oauth.getQQ().getOpenid_callback_uri() + "?access_token=" + reulsts.get("access_token"));
			// callback( {"client_id":"101887062","openid":"74DD1353321FD56375F34422D833848D"} );
			System.out.println("openidContent: " + openidContent);

			//æ¥ä¸‹æ¥å¯¹openidè¿›è¡Œå¤„ç†
			//æˆªå–éœ€è¦çš„é‚£éƒ¨åˆ†jsonå­—ç¬¦ä¸²
			String openid = openidContent.substring(openidContent.indexOf("{"), openidContent.indexOf("}") + 1);
			// json è½¬ å¯¹è±¡
			Gson gson = new Gson();
			//å°†è¿”å›çš„openidè½¬æ¢æˆDTO
			QQOpenidDTO qqOpenidDTO = gson.fromJson(openid, QQOpenidDTO.class);

			// å°è£…å‚æ•° è¯·æ±‚ç”¨æˆ·ä¿¡æ¯æ•°æ®
			params.clear();
			//è®¾ç½®access_token
			params.put("access_token", reulsts.get("access_token"));
			//è®¾ç½®openid
			params.put("openid", qqOpenidDTO.getOpenid());
			//è®¾ç½®appid
			params.put("oauth_consumer_key", qqOpenidDTO.getClient_id());
			//è·å–ç”¨æˆ·ä¿¡æ¯
			String userInfo = HttpsUtils.doGet(oauth.getQQ().getUser_info_callback_uri(), params);
			QQDTO qqDTO = gson.fromJson(userInfo, QQDTO.class);
			// ï¼ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨å¼€å‘æ—¶å€™ç”¨openidä½œä¸ºç”¨æˆ·åï¼Œå†è‡ªå·±å®šä¹‰ä¸ªå¯†ç å°±å¯ä»¥äº†ï¼‰
			try {

				  /* ç»„è£…æ•°æ® */
				  HashMap<String, Object> map = new HashMap<>();
				  map.put("user", qqDTO);
				  map.put("qqOpenidDTO", qqOpenidDTO);
				  request.setAttribute("map", map);
				  log.info("useræ•°æ®:{}" + qqDTO);
				  log.info("qqOpenidDTOæ•°æ®:{}" + qqOpenidDTO);
				  return "home";
			} catch (Exception e) {
				  e.printStackTrace();
				  return "login";
			}
	  }


	  /**
	   * è·å–è…¾è®¯ access_token
	   *
	   * @return
	   */
	  public Map<String, String> getAccess_token(HashMap<String, Object> params) {
			// è®¤è¯åœ°å€
			//è·å–access_tokenå¦‚ï¼šaccess_token=9724892714FDF1E3ED5A4C6D074AF9CB&expires_in=7776000&refresh_token=9E0DE422742ACCAB629A54B3BFEC61FF
			String result = HttpsUtils.doGet(oauth.getQQ().getAccess_token_callback_uri(), params);
			//å¯¹æ‹¿åˆ°çš„æ•°æ®è¿›è¡Œåˆ‡å‰²å­—ç¬¦ä¸²
			String[] strings = result.split("&");
			//åˆ‡å‰²å¥½åæ”¾è¿›map
			Map<String, String> reulsts = new HashMap<>();
			for (String str : strings) {
				  String[] split = str.split("=");
				  if (split.length > 1) {
						reulsts.put(split[0], split[1]);
				  }
			}
			return reulsts;
	  }


}

```

### åˆ›å»ºQQå‚æ•°å®ä½“ç±»

#### åˆ›å»º  OAuthProperties  ç”¨äºé…åˆymlé…ç½®æ–‡ä»¶åŠ¨æ€è·å–å‚æ•°

```java
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * description:  æ¨ä¸æ˜“ç½‘ç«™ :www.yangbuyi.top
 * ClassName:  OAuthProperties
 * create:  2020-06-24 17:06
 *
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 * <p>
 * è·å–Codeç 
 **/

@Component
//å¯¹åº”application.ymlä¸­ï¼Œoauthä¸‹å‚æ•°
@ConfigurationProperties(prefix = "oauth")
public class OAuthProperties {
      
      //è·å–applicaiton.ymlä¸‹qqä¸‹æ‰€æœ‰çš„å‚æ•°
      private QQProperties qq = new QQProperties();
      
      public QQProperties getQQ() {
            return qq;
      }
      
      public void setQQ(QQProperties qq) {
            this.qq = qq;
      }
}

```

#### åˆ›å»º QQProperties ç”¨äºè¯·æ±‚qqçš„å‚æ•°

```java
import lombok.Data;
import org.springframework.stereotype.Component;

/**
 * description:  æ¨ä¸æ˜“ç½‘ç«™ :www.yangbuyi.top
 * ClassName:  QQProperties
 * create:  2020-06-24 17:04
 *
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 *
 * é›†æˆç¬¬ä¸‰æ–¹ç™»é™† QQ  å‚æ•°
 **/
@Data
@Component
public class QQProperties {
      /**
       * ä½ çš„appid
       */
      private String client_id;
      /**
       *  #ä½ çš„appkey
       */
      private String client_secret;
      /**
       * ä½ æ¥æ”¶å“åº”codeç åœ°å€
       */
      private String redirect_uri;
      /**
       * è…¾è®¯è·å–codeç åœ°å€
       */
      private String code_callback_uri;
      /**
       * è…¾è®¯è·å–access_tokenåœ°å€
       */
      private String access_token_callback_uri;
      /**
       * è…¾è®¯è·å–openidåœ°å€
       */
      private String openid_callback_uri;
      /**
       * è…¾è®¯è·å–ç”¨æˆ·ä¿¡æ¯åœ°å€
       */
      private String user_info_callback_uri;
      
      
      /**
       * è¦å›è°ƒåˆ°å“ªä¸ªç½‘ç«™
       */
      private String redirect_url_index_yby;
      private String redirect_url_login_yby;
    
}


```

### åˆ›å»º QQOpenidDTO ç”¨äºè·å– access_tokenã€openid

```java
import lombok.Data;

/**
 * description:  æ¨ä¸æ˜“ç½‘ç«™ :www.yangbuyi.top
 * ClassName:  QQOpenidDTO
 * create:  2020-06-24 17:19
 *
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 *
 * ç”¨æ¥è·å– access_tokenã€openid
 **/
@Data

public class QQOpenidDTO {
      
      private String openid;
      
      private String client_id;
      
}

```


### åˆ›å»ºQQDTO æ¥æ”¶QQè¿”å›æ¥çš„jsonå‚æ•°

```java
import lombok.Data;

/**
 * description:  æ¨ä¸æ˜“ç½‘ç«™ :www.yangbuyi.top
 * program:  yangbuyi-erp-2020
 * ClassName:  QQDTO
 * create:  2020-06-24 17:20
 *
 * @author: yangbuyi
 * @sinceï¼š JDK1.8
 * @QQDTO: ç”¨äºå­˜å‚¨QQæœåŠ¡å™¨è¿”å›æ¥çš„å‚æ•°
 **/

@Data
public class QQDTO {
      
      private String ret;        //è¿”å›ç 
      private String msg;        //å¦‚æœret<0ï¼Œä¼šæœ‰ç›¸åº”çš„é”™è¯¯ä¿¡æ¯æç¤ºï¼Œè¿”å›æ•°æ®å…¨éƒ¨ç”¨UTF-8ç¼–ç ã€‚
      private String nickname;             //ç”¨æˆ·åœ¨QQç©ºé—´çš„æ˜µç§°ã€‚
      private String figureurl;              //å¤§å°ä¸º30Ã—30åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚
      private String figureurl_1;                //å¤§å°ä¸º50Ã—50åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚
      private String figureurl_2;                //å¤§å°ä¸º100Ã—100åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚
      private String figureurl_qq_1;                   //å¤§å°ä¸º40Ã—40åƒç´ çš„QQå¤´åƒURLã€‚
      private String figureurl_qq_2;                   //å¤§å°ä¸º100Ã—100åƒç´ çš„QQå¤´åƒURLã€‚éœ€è¦æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„ç”¨æˆ·éƒ½æ‹¥æœ‰QQçš„100x100çš„å¤´åƒï¼Œä½†40x40åƒç´ åˆ™æ˜¯ä¸€å®šä¼šæœ‰ã€‚
      private String gender;           //æ€§åˆ«ã€‚ å¦‚æœè·å–ä¸åˆ°åˆ™é»˜è®¤è¿”å›"ç”·"
      private Integer gendertype; // æ€§åˆ« æ•°å­—
      private String is_yellow_vip;                  //æ ‡è¯†ç”¨æˆ·æ˜¯å¦ä¸ºé»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼›1ï¼šæ˜¯ï¼‰ã€‚
      private String vip;        //æ ‡è¯†ç”¨æˆ·æ˜¯å¦ä¸ºé»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼›1ï¼šæ˜¯ï¼‰
      private String yellow_vip_level;                     //é»„é’»ç­‰çº§
      private String level;          //é»„é’»ç­‰çº§
      private String is_yellow_year_vip;                       //æ ‡è¯†æ˜¯å¦ä¸ºå¹´è´¹é»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼› 1ï¼šæ˜¯ï¼‰
      private String province; // çœ
      private String city; // å¸‚
}

```






ç¤ºä¾‹

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1ViqAaRY9AAAP5cTGO3M253.png)


### åˆ›å»ºå‰ç«¯è¯·æ±‚è·³è½¬ controller

```java
@Controller
@Slf4j
public class RequestController {

	  @RequestMapping("login")
	  public String login() {
			System.out.println("ç™»é™†è¿›æ¥å•¦");
			return "login";
	  }

	  @RequestMapping("home")
	  public String home() {
			return "home";
	  }

}

```

### åˆ›å»ºå‰ç«¯é¡µé¢

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1VAmAWUEqAAAZhCVy8Ec239.png)

#### login.html

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<!--
    ç™»å½•åœ°å€    action="/api/login/oauth"
-->
<form action="/api/login/oauth">
    <input type="submit" style="background: red;size: 25px" value="ç™»é™†">
</form>
</body>
</html>

```

#### home.html

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="">
    <label class="">ç™»é™†æˆåŠŸ</label>
    <div class="">
        <p th:text="'openID :' + ${map.qqOpenidDTO.openid}"></p>

        <p th:text="'ç”¨æˆ·åç§° :' + ${map.user.nickname}"></p>

        ç”¨æˆ·å¤´åƒ:
        <img th:src="${map.user.figureurl_qq_1}" alt="">
        <br>
        <img th:src="${map.user.figureurl_qq_1}" alt="">
        <img th:src="${map.user.figureurl_qq_2}" alt="">


        æ€§åˆ«:
        <p th:text="${map.user.gender}"></p>


        <p th:text="${map.user.vip}"></p>
        <p th:text="${map.user.yellow_vip_level}"></p>
        <p th:text="${map.user.is_yellow_year_vip}"></p>
        <p th:text="${map.user.province}"></p>
        <p th:text="${map.user.city}"></p>

    </div>
</div>

<!--å‚æ•°åˆ—è¡¨:-->
<!--private String ret; //è¿”å›ç -->
<!--private String msg; //å¦‚æœret<0ï¼Œä¼šæœ‰ç›¸åº”çš„é”™è¯¯ä¿¡æ¯æç¤ºï¼Œè¿”å›æ•°æ®å…¨éƒ¨ç”¨UTF-8ç¼–ç ã€‚-->
<!--private String nickname; //ç”¨æˆ·åœ¨QQç©ºé—´çš„æ˜µç§°ã€‚-->
<!--private String figureurl; //å¤§å°ä¸º30Ã—30åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚-->
<!--private String figureurl_1; //å¤§å°ä¸º50Ã—50åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚-->
<!--private String figureurl_2; //å¤§å°ä¸º100Ã—100åƒç´ çš„QQç©ºé—´å¤´åƒURLã€‚-->
<!--private String figureurl_qq_1; //å¤§å°ä¸º40Ã—40åƒç´ çš„QQå¤´åƒURLã€‚-->
<!--private String figureurl_qq_2; //å¤§å°ä¸º100Ã—100åƒç´ çš„QQå¤´åƒURLã€‚éœ€è¦æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„ç”¨æˆ·éƒ½æ‹¥æœ‰QQçš„100x100çš„å¤´åƒï¼Œä½†40x40åƒç´ åˆ™æ˜¯ä¸€å®šä¼šæœ‰ã€‚-->
<!--private String gender; //æ€§åˆ«ã€‚ å¦‚æœè·å–ä¸åˆ°åˆ™é»˜è®¤è¿”å›"ç”·"-->
<!--private Integer gendertype; // æ€§åˆ« æ•°å­—-->
<!--private String is_yellow_vip; //æ ‡è¯†ç”¨æˆ·æ˜¯å¦ä¸ºé»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼›1ï¼šæ˜¯ï¼‰ã€‚-->
<!--private String vip; //æ ‡è¯†ç”¨æˆ·æ˜¯å¦ä¸ºé»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼›1ï¼šæ˜¯ï¼‰-->
<!--private String yellow_vip_level; //é»„é’»ç­‰çº§-->
<!--private String level; //é»„é’»ç­‰çº§-->
<!--private String is_yellow_year_vip; //æ ‡è¯†æ˜¯å¦ä¸ºå¹´è´¹é»„é’»ç”¨æˆ·ï¼ˆ0ï¼šä¸æ˜¯ï¼› 1ï¼šæ˜¯ï¼‰-->
<!--private String province; // çœ-->
<!--private String city; // å¸‚-->


</body>
</html>
```

### å¯åŠ¨æ³¨æ„äº‹é¡¹

å¿…é¡»è¦æ‰“åŒ…åˆ°æœåŠ¡å™¨å¯åŠ¨QQæ‰èƒ½å›è°ƒ

# é¡¹ç›®éƒ¨ç½²

æ–¹æ¡ˆä¸€:

ç‚¹å‡»package æ‰“åŒ…

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WGKAGsziAAA6rF-mT84991.png)

å¤åˆ¶ é¡¹ç›® å’Œ application.yml ä¸Šä¼ åˆ°linuxæœåŠ¡å™¨
![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WIyAZL90AAAlVRGKPCA937.png)

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WJ2ABZYZAAApYyKRlMc707.png)


ä¿®æ”¹application.yml ä¸­çš„ç«¯å£ä¸º 80 

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WiiAJ570AADOVFxqV48964.png)

è¿è¡Œ Javaç¨‹åº

`java -jar qqlogindemo-0.0.1-SNAPSHOT.jar `


å¯åŠ¨æˆåŠŸ

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1Wk-AO6uYAAHHR6o4Y0A001.png)


è®¿é—® login é¡µé¢
![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WlKANkagAABReRxnILE224.png)

ç‚¹å‡»ç™»å½• ã€‹ QQæ‰«ç æˆ–è€…å¯†ç ç™»å½• ã€‹ ç™»å½•æˆåŠŸ è·³è½¬åˆ° home

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WneAMwnQAAEhAT0ylYw886.png)

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WxSADXusAAFn4EP-mnA908.png)

![image.png](http://yangbuyi.top:81/group1/M00/00/00/rBEACGB1WuWAec-eAAEKl7Xrtx8174.png)


## æ–¹æ¡ˆäºŒï¼š
ç°åœ¨å¤§éƒ¨åˆ†éƒ½æ˜¯ å‰åç«¯åˆ†ç¦»ä¸€å®šä½¿ç”¨nginxä»£ç†æ¥è¿›è¡Œè½¬å‘ æˆ‘ä»¬ä½¿ç”¨nginxæ¥è¿›è¡Œ 
ä¿®æ”¹ application.yml ç«¯å£ä¸º é™¤ 80 ä»¥å¤–çš„ç«¯å£ å› ä¸º 80æ˜¯nginxçš„é»˜è®¤ç«¯å£

![](https://img2020.cnblogs.com/blog/1735255/202104/1735255-20210414093004437-1693981825.png)

ä¿®æ”¹ä½ æœåŠ¡å™¨ä¸Šçš„nginx.config æ–‡ä»¶
![](https://img2020.cnblogs.com/blog/1735255/202104/1735255-20210414093117221-94546096.png)

```java
  # ç›‘å¬å›è°ƒåœ°å€ä¸ºapiè¯·æ±‚çš„ å¹¶ä¸”åå‘ä»£ç†åˆ° xxxxç«¯å£ å³å¯
 location ^~/api {
        proxy_pass http://yangbuyi.top:xxxx;
        proxy_send_timeout 1800;
        proxy_read_timeout 1800;
        proxy_connect_timeout 1800;
           client_max_body_size 2048m;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_set_header  Host             $host:$server_port;

            proxy_set_header  X-Real-IP         $remote_addr;
            proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header  X-Forwarded-Proto $scheme;

    }
``` 

åˆ·æ–° nginx 

é‡æ–°å¯åŠ¨ Javaç¨‹åº  æ­¥éª¤å°±ä¸ æ–¹æ¡ˆä¸€ ä¸€è‡´  


### åˆ°æ­¤ ä»é›¶ç©è½¬ ç¬¬ä¸‰æ–¹ç™»å½•ä¹‹QQç™»å½• å°±ç»“æŸäº†å“¦ã€‚

## GITEEï¼šhttps://gitee.com/yangbuyi

## GITHUB: https://github.com/GenuineYangShuai

## ä¸ªäººåšå®¢ç½‘ç«™ï¼š https://www.yangbuyi.top/

## æ˜¥å¤©äº¤æµç¾¤ ï¼š598347590

![img](https://img2020.cnblogs.com/blog/1735255/202104/1735255-20210410001539948-1526153320.png)

## ğŸºä½ çš„å‹åŠ›æºäºæ— æ³•è‡ªå¾‹ï¼Œåªæ˜¯å‡è£…åŠªåŠ›ï¼Œç°çŠ¶è·Ÿä¸ä¸Šä½ å†…å¿ƒçš„æ¬²æœ›ï¼Œæ‰€ä»¥ä½ ç„¦æ€¥åˆææ…Œ---æ¨ä¸æ˜“.|



### æœ¬æ–‡ä½œè€…ï¼šæ¨ä¸æ˜“å‘€

### æœ¬æ–‡é“¾æ¥ï¼šhttps://www.yangbuyi.top/qqLogin

### ç‰ˆæƒå£°æ˜ï¼šæœ¬ä½œå“é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 2.5 ä¸­å›½å¤§é™†[è®¸å¯åè®®](https://www.cnblogs.com/Yangbuyi/p/14639371.html)è¿›è¡Œè®¸å¯ã€‚